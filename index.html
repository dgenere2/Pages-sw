<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title >Report@Appgro</title>
<link rel="manifest" href="./manifest.json">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="stylesheet" href="css/estilos.css" />
</head>
<body>
<header class="app-bar">
  <div class="left-group">
    <button id="menu-toggle" class="menu-btn">&#9776;</button>
    <h1 class="title">Report@ Agro</h1>
  </div>

  <div class="right-group">
    <div id="boton-login"></div>
    <div id="resultado"></div>
    <button id="logout" style="display:none;">Cerrar sesi√≥n</button>
  </div>
</header>



  <nav id="sidebar">
    <ul>
      <li><a href="#"><span>üè†</span> Inicio</a></li>
      <li><a href="#"><span>üìÑ</span> Servicios</a></li>
      <li><a href="#"><span>‚ÑπÔ∏è</span> Acerca de</a></li>
      <li><a href="#"><span>‚úâÔ∏è</span> Contacto</a></li>
    </ul>
  </nav>

 <div id="update-alert" style="display:none; position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
background: #333; color: #fff; padding: 10px 20px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.3); z-index: 9999;">
  Nueva versi√≥n disponible. <button onclick="window.location.reload()" style="margin-left:10px; background:#4CAF50; color:white; border:none; padding:5px 10px; border-radius:4px;">Actualizar</button>
</div>
  
  <div id="overlay"></div>

  <main>
    <section class="content">
      <h2>Facturaci√≥n</h2>
      <p>Ingrese los datos para facturar.</p>
    </section>
  </main>

  <!-- FORMULARIO -->
<form id="formulario" class="formulario">
  <label for="cliente">Cliente</label>
  <input type="text" id="cliente" required />

  <label for="fecha">Fecha</label>
  <input type="date" id="fecha" required />

   <label for="peso">Peso</label>
  <input  oninput = "calcularMonto()" type="number" id="peso" step="0.01" required />
  <select id="medida">
    <option>Libras</option>
    <option>Kilogramos</option>
    <option>Quintal</option>
  </select>

  <label for="unitario">Precio unitario</label>
  <input oninput = "calcularMonto()" type="number" id="unitario" step="0.01" required />

  <label for="servicio">Concepto</label>
  <input type="text" id="servicio" required />

  <label for="monto">Monto (RD$)</label>
  <input readonly type="number" id="monto" step="0.01" required />

  <button type="submit">Generar Recibo</button>
</form>

  <div id="boton-login"></div>
    <div id="resultado"></div>

<!-- RECIBO -->
<div id="recibo" class="recibo" style="display:none;">
  <h2 id="r-negocio"></h2>
  <h5 id="r-descipcion"></h5>
  <h3 id="r-documento"></h3>
  <p><strong>No. recibo:</strong> <span id="r-factura"></span></p>
    <p><strong>Cliente:</strong> <span id="r-cliente"></span></p>
  <p><strong>Fecha:</strong> <span id="r-fecha"></span></p>
  <p><strong>Peso:</strong><span id="r-peso"></span><span id="r-medida"></span></p>
  <p><strong>Precio und.:</strong> <span id="r-punitario"></span></p>
  <p><strong>Concepto:</strong> <span id="r-servicio"></span></p>
  <p><strong>Monto:</strong> RD$ <span id="r-monto"></span></p>
  <hr />
  <p>Gracias por su preferencia.</p>
   <button class="btn-imprimir" onclick="imprimirRecibo()">üñ®Ô∏è Imprimir</button> 
</div>


<script src="https://accounts.google.com/gsi/client" async defer></script>
<div class="g_id_signin" data-type="standard"></div>
  


<script>
  function handleCredentialResponse(response) {
    const id_token = response.credential;

    const URL = "https://script.google.com/macros/s/AKfycby-pxRLDBzdIvwzNSnKzo_UJDhCBHr5oWCgkVI6yb4GC3tZNKArhfTuggIIuSWRv4CZ6Q/exec";
    fetch(URL, {
      method: "POST",
      headers: {
        "Content-Type": "text/plain"
      },
      body: JSON.stringify({ id_token }),
      redirect: "follow"
    })
    .then(res => res.json())
    .then(data => {
      if (data.status === "success") {
        localStorage.setItem("userEmail", data.email);
        localStorage.setItem("id_token", id_token);
        document.getElementById("r-negocio").textContent = data.negocio
        document.getElementById("r-descipcion").textContent = data.decripcion
        document.getElementById("r-documento").textContent = data.documento
        document.getElementById("resultado").textContent = data.email;
        document.getElementById("logout").style.display = "inline-block";
        document.getElementById("boton-login").innerHTML = ""; // Oculta login
      } else {
        console.error("Error de autenticaci√≥n");
      }
    })
    .catch(error => {
      console.error("Error en la autenticaci√≥n:", error);
    });
  }

 function iniciarGoogleLogin() {
    google.accounts.id.initialize({
      client_id: "197964323281-d8hr205c5urqml3f5csqduvii90eo0pu.apps.googleusercontent.com",
      callback: handleCredentialResponse
    });
    google.accounts.id.renderButton(
      document.getElementById("boton-login"),
      { theme: "outline", size: "small" }
    );
  }

  window.onload = function () {
    const emailGuardado = localStorage.getItem("userEmail");
    if (emailGuardado) {
      document.getElementById("resultado").textContent = emailGuardado;
      document.getElementById("logout").style.display = "inline-block";
    } else {
      iniciarGoogleLogin();
    }

    document.getElementById("logout").addEventListener("click", function () {
      localStorage.removeItem("userEmail");
      localStorage.removeItem("id_token");
      document.getElementById("resultado").textContent = "";
      document.getElementById("logout").style.display = "none";
      iniciarGoogleLogin(); // Vuelve a mostrar bot√≥n de login
    });
  };

  function calcularMonto() {
   var cantidad = document.getElementById("peso").value
     var pricioUnitario = document.getElementById("unitario").value
    var montoTotal = pricioUnitario * cantidad

    if (cantidad == "" || pricioUnitario == ""){ return}
    
    
    document.getElementById("monto").value =  parseFloat(montoTotal).toFixed(2)

    }
  
</script>




<script>
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js').then(reg => {
      console.log('‚úÖ SW registrado:', reg);

      reg.onupdatefound = () => {
        const newWorker = reg.installing;
        newWorker.onstatechange = () => {
          if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
            // Mostrar aviso
            document.getElementById('update-alert').style.display = 'block';
          }
        };
      };
    }).catch(err => {
      console.error('‚ùå Error al registrar SW:', err);
    });
  }

  // Men√∫ lateral
  document.getElementById('menu-toggle').addEventListener('click', () => {
    document.getElementById('sidebar').classList.toggle('active');
    document.getElementById('overlay').classList.toggle('active');
  });

  document.getElementById('overlay').addEventListener('click', () => {
    document.getElementById('sidebar').classList.remove('active');
    document.getElementById('overlay').classList.remove('active');
  });

</script>

  
<script>
document.getElementById("formulario").addEventListener("submit", async function (e) {
  e.preventDefault();

  const id_token = localStorage.getItem("id_token");
  const emailGuardado = localStorage.getItem("userEmail");
  var noFactura = getIdDinamico();
  if (!id_token) {
    alert("Debe iniciar sesi√≥n para guardar la factura.");
    return;
  }

  console.log("Factura ID:", noFactura);

  const factura = {
    cliente: document.getElementById("cliente").value,
    fecha: document.getElementById("fecha").value,
    servicio: document.getElementById("servicio").value,
    monto: parseFloat(document.getElementById("monto").value).toFixed(2),
    peso: parseFloat(document.getElementById("peso").value).toFixed(2),
    usuario: emailGuardado,
    token: id_token,
    nofactura: noFactura,
    medida: document.getElementById("medida").value,
    preciounidad: document.getElementById("unitario").value 
  };

   document.getElementById("cliente").value = ""
   document.getElementById("fecha").value = ""
   document.getElementById("servicio").value = ""
   document.getElementById("monto").value  = ""
  document.getElementById("peso").value  = ""


  // Mostrar recibo
  document.getElementById("r-cliente").textContent = factura.cliente;
  document.getElementById("r-fecha").textContent = factura.fecha;
  document.getElementById("r-servicio").textContent = factura.servicio;
  document.getElementById("r-monto").textContent = factura.monto;
  document.getElementById("recibo").style.display = "block";
  document.getElementById("r-peso").textContent =  factura.peso 
  document.getElementById("r-factura").textContent =  factura.nofactura
   document.getElementById("r-medida").textContent = " " + factura.medida
   document.getElementById("r-punitario").textContent = factura.preciounidad
  

  // Guardar en l√≠nea o local
 if (navigator.onLine) {
  try {
    const respuesta = await enviarFacturaAScript(factura);
    if (!respuesta.ok) throw new Error("Error en servidor"); // si no fue exitoso, lanza error
  } catch (err) {
    console.warn("Error al enviar online, guardando en localStorage:", err);
    guardarEnLocal(factura); // solo se guarda si realmente fall√≥
  }
} else {
  guardarEnLocal(factura);
}

});

      function getIdDinamico() {
  return new Date().getTime() + '-' + (Math.floor(Math.random() * 100) + 1);

}   
  

// Enviar a Apps Script
async function enviarFacturaAScript(factura) {
  const url = "https://script.google.com/macros/s/AKfycbzDrqkdfYA9egr4esL2PGdXMIgMdl5ob6hGItBjzE1R9ydd0C1htdrtbI0zZmSxvLZl/exec"; // Reemplazar con tu URL del Web App de Apps Script
  const res = await fetch(url, {
    method: "POST",
    headers: {
      "Content-Type": "text/plain"
    },
    body: JSON.stringify(factura),
    redirect: "follow"
  });

  if (!res.ok) throw new Error("Error en respuesta del servidor");

  return res;
}

// Guardar en localStorage
function guardarEnLocal(factura) {
  const pendientes = JSON.parse(localStorage.getItem("facturas_pendientes")) || [];
  pendientes.push(factura);
  localStorage.setItem("facturas_pendientes", JSON.stringify(pendientes));
}
</script>


  <script>

  // Funci√≥n de impresi√≥n
  function imprimirRecibo() {
    const contenido = document.getElementById("recibo").innerHTML;
    const ventana = window.open('', '', 'width=400,height=600');
    ventana.document.write('<html><head><title>Recibo</title><style>');
    ventana.document.write(`
      body { font-family: monospace; padding: 10px; font-size: 14px; }
      h2 { text-align: center; }
      p { margin: 4px 0; }
      hr { margin: 10px 0; }
    `);
    ventana.document.write('</style></head><body>');
    ventana.document.write(contenido);
    ventana.document.write('</body></html>');
    ventana.document.close();
    ventana.print();
  }
</script>

  <script>
window.addEventListener("online", function () {
  const pendientes = JSON.parse(localStorage.getItem("facturas_pendientes")) || [];

  if (pendientes.length > 0) {
    pendientes.forEach(async (factura, index) => {
      try {
        await enviarFacturaAScript(factura);
        pendientes.splice(index, 1); // Eliminar la que ya se envi√≥
        localStorage.setItem("facturas_pendientes", JSON.stringify(pendientes));
      } catch (err) {
        console.warn("No se pudo sincronizar una factura:" + err);
      }
    });
  }
});

    
</script>

  
</body>
</html>
